import json
from google import genai
import streamlit as st

def get_client():
    """–°—Ç–≤–æ—Ä—é—î –∫–ª—ñ—î–Ω—Ç–∞ –∑ API –∫–ª—é—á–µ–º –∑ —Å–µ–∫—Ä–µ—Ç—ñ–≤"""
    api_key = None
    if "gemini" in st.secrets and "GEMINI_API_KEY" in st.secrets["gemini"]:
        api_key = st.secrets["gemini"]["GEMINI_API_KEY"]
    elif "GEMINI_API_KEY" in st.secrets:
        api_key = st.secrets["GEMINI_API_KEY"]
    
    if not api_key: return None
    return genai.Client(api_key=api_key)

def get_ai_analysis(question_text, data, data_type="stats"):
    """–ê–Ω–∞–ª—ñ–∑ –û–î–ù–û–ì–û –ø–∏—Ç–∞–Ω–Ω—è (–¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø—ñ–¥ –∫–∞—Ä—Ç–∫–æ—é)"""
    try:
        client = get_client()
        if not client: return "‚ö†Ô∏è –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ API –∫–ª—é—á–∞."

        base_prompt = "–†–æ–ª—å: –°–æ—Ü—ñ–æ–ª–æ–≥. –ú–æ–≤–∞: –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞. –ú–∞–∫—Å–∏–º—É–º 3 –∞–±–∑–∞—Ü–∏. –í–∏–¥—ñ–ª—è–π –≥–æ–ª–æ–≤–Ω–µ **–∂–∏—Ä–Ω–∏–º**."
        
        prompt = ""
        if data_type == "text":
            prompt = f"{base_prompt} –ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ: '{question_text}'. –°–ø–∏—Å–æ–∫: {str(data[:60])}. –í–∏–¥—ñ–ª–∏ —Ç–µ–º–∏ —Ç–∞ –Ω–∞—Å—Ç—Ä—ñ–π."
        else:
            prompt = f"{base_prompt} –ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É: '{question_text}'. –î–∞–Ω—ñ: {data}. –û–ø–∏—à—ñ—Ç—å –ª—ñ–¥–µ—Ä—ñ–≤ —Ç–∞ —Ä–æ–∑–ø–æ–¥—ñ–ª."

        response = client.models.generate_content(
            model='gemini-2.5-flash', 
            contents=prompt
        )
        return response.text
    except Exception as e:
        return f"–ü–æ–º–∏–ª–∫–∞ AI: {e}"

def analyze_whole_survey(survey_title, questions_list):
    """
    –ü–ê–ö–ï–¢–ù–ò–ô –ê–ù–ê–õ–Ü–ó: –í—ñ–¥–ø—Ä–∞–≤–ª—è—î –≤—Å–µ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è –æ–¥–Ω–∏–º –∑–∞–ø–∏—Ç–æ–º.
    –ü–æ–≤–µ—Ä—Ç–∞—î —Å–ª–æ–≤–Ω–∏–∫ {—ñ–Ω–¥–µ–∫—Å_–ø–∏—Ç–∞–Ω–Ω—è: —Ç–µ–∫—Å—Ç_–∞–Ω–∞–ª—ñ–∑—É}.
    """
    try:
        client = get_client()
        if not client: return None

        # 1. –§–æ—Ä–º—É—î–º–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑ —É—Å—ñ—Ö –ø–∏—Ç–∞–Ω—å
        context_data = []
        for idx, q in enumerate(questions_list):
            q_text = q.get('text')
            q_data = q.get('data')
            
            # –°–∫–æ—Ä–æ—á—É—î–º–æ —Ç–µ–∫—Å—Ç, —â–æ–± –∑–µ–∫–æ–Ω–æ–º–∏—Ç–∏ —Ç–æ–∫–µ–Ω–∏ (—Ö–æ—á–∞ –ª—ñ–º—ñ—Ç –¥–æ–∑–≤–æ–ª—è—î, –∫—Ä–∞—â–µ –Ω–µ —Å–º—ñ—Ç–∏—Ç–∏)
            content = ""
            if q.get('type') == 'text' and isinstance(q_data, dict):
                content = str(q_data.get('answers', [])[:40]) 
            else:
                content = str(q_data)
                
            context_data.append(f"Q_ID {idx}: '{q_text}' -> Data: {content}")

        full_text = "\n".join(context_data)

        # 2. –ü—Ä–æ–º–ø—Ç –∑ –≤–∏–º–æ–≥–æ—é JSON
        prompt = f"""–¢–∏ –∞–Ω–∞–ª—ñ—Ç–∏–∫. –ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è.

–ù–∞–∑–≤–∞: {survey_title}

–ü–∏—Ç–∞–Ω–Ω—è:
{full_text}

–ó–∞–≤–¥–∞–Ω–Ω—è: –î–ª—è –∫–æ–∂–Ω–æ–≥–æ –ø–∏—Ç–∞–Ω–Ω—è (Q_ID) –Ω–∞–ø–∏—à–∏ –≤–∏—Å–Ω–æ–≤–æ–∫ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é (3-4 –∞–±–∑–∞—Ü–∏).

–û–ë–û–í'–Ø–ó–ö–û–í–û –ø–æ–≤–µ—Ä–Ω–∏ –¢–Ü–õ–¨–ö–ò –≤–∞–ª—ñ–¥–Ω–∏–π JSON –±–µ–∑ –¥–æ–¥–∞—Ç–∫–æ–≤–æ–≥–æ —Ç–µ–∫—Å—Ç—É.
–§–æ—Ä–º–∞—Ç: {{"0": "—Ç–µ–∫—Å—Ç –≤–∏—Å–Ω–æ–≤–∫—É", "1": "—Ç–µ–∫—Å—Ç –≤–∏—Å–Ω–æ–≤–∫—É"}}
–ù–µ –¥–æ–¥–∞–≤–∞–π –Ω–∏–∫–∞–∫–∏—Ö –ø–æ—è—Å–Ω–µ–Ω—å, —Ç—ñ–ª—å–∫–∏ JSON."""

        # 3. –ó–∞–ø–∏—Ç (–∑–º—É—à—É—î–º–æ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ JSON)
        response = client.models.generate_content(
            model='gemini-2.5-flash',
            contents=prompt,
            config={'response_mime_type': 'application/json'}
        )
        
        # –û—á–∏—â—É—î–º–æ —Ç–µ–∫—Å—Ç –≤—ñ–¥ –º–æ–∂–ª–∏–≤–∏—Ö –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ñ–≤
        response_text = response.text.strip()
        # –í–∏–¥–∞–ª—è—î–º–æ –≤—Å–µ –¥–æ –ø–µ—Ä—à–æ—ó { —Ç–∞ –ø—ñ—Å–ª—è –æ—Å—Ç–∞–Ω–Ω—å–æ—ó }
        if '{' in response_text and '}' in response_text:
            response_text = response_text[response_text.find('{'):response_text.rfind('}')+1]
        
        result = json.loads(response_text)
        
        # 4. –§—ñ–ª—å—Ç—Ä—É—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç - –∑–∞–ª–∏—à–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ —á–∏—Å–ª–æ–≤—ñ –∫–ª—é—á—ñ (–∏–Ω–¥–µ–∫—Å–∏ –ø–∏—Ç–∞–Ω—å)
        filtered_result = {}
        for key, value in result.items():
            try:
                idx = int(key)
                filtered_result[idx] = value
            except ValueError:
                # –Ü–≥–Ω–æ—Ä—É—î–º–æ –∫–ª—é—á—ñ, —è–∫—ñ –Ω–µ —î —á–∏—Å–ª–∞–º–∏
                pass
        
        return filtered_result if filtered_result else None

    except Exception as e:
        st.error(f"Batch Error: {e}")
        return None


def generate_survey_description(survey_title, questions_list):
    """
    üéØ –ì–ï–ù–ï–†–ê–¶–Ü–Ø –û–ü–ò–°–£ –û–ü–ò–¢–£–í–ê–ù–ù–Ø (–¥–ª—è –∞–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—ñ)
    
    –°—Ç–≤–æ—Ä—é—î –∫–æ—Ä–æ—Ç–∫–∏–π (2-3 —Ä–µ—á–µ–Ω–Ω—è) –æ–ø–∏—Å –Ω–∞ –æ—Å–Ω–æ–≤—ñ –Ω–∞–∑–≤–∏ —Ç–∞ –ø–∏—Ç–∞–Ω—å.
    –í–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è, —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ –ë–î.
    
    –ü–∞—Ä–∞–º–µ—Ç—Ä–∏:
        survey_title (str): –ù–∞–∑–≤–∞ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è
        questions_list (list): –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–Ω–∏–∫—ñ–≤ –ø–∏—Ç–∞–Ω—å –∑ –ø–æ–ª–µ–º 'text'
    
    –ü–æ–≤–µ—Ä—Ç–∞—î:
        str: –¢–µ–∫—Å—Ç –æ–ø–∏—Å—É –∞–±–æ None –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ
    """
    try:
        client = get_client()
        if not client:
            return None

        # –ó–±–∏—Ä–∞—î–º–æ —Å–ø–∏—Å–æ–∫ –ø–∏—Ç–∞–Ω—å (—Ç—ñ–ª—å–∫–∏ —Ç–µ–∫—Å—Ç)
        questions_text = "\n".join([f"‚Ä¢ {q.get('text')}" for q in questions_list])

        prompt = f"""
–ó–∞–¥–∞—á–∞: –ù–∞–ø–∏—à–∏ –ö–û–†–û–¢–ö–ï –ø–æ—è—Å–Ω–µ–Ω–Ω—è –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è (2-3 —Ä–µ—á–µ–Ω–Ω—è –º–∞–∫—Å–∏–º—É–º) –¥–ª—è –∫–∞—Ç–∞–ª–æ–≥—É –æ–ø–∏—Ç—É–≤–∞–Ω—å.

–ö–æ–Ω—Ç–µ–∫—Å—Ç: –¶–µ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è –ø—Ä–æ –º–æ–ª–æ–¥—å —Ç–∞ IT —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ñ YouthPulse.

–ù–∞–∑–≤–∞: {survey_title}

–ü–∏—Ç–∞–Ω–Ω—è –≤ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—ñ:
{questions_text}

–§–æ—Ä–º–∞—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ:
1. –©–û –¥–æ—Å–ª—ñ–¥–∂—É—î—Ç—å—Å—è (—Ç–µ–º–∏, —Ñ–æ–∫—É—Å –¥–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—è)
2. –î–õ–Ø –ö–û–ì–û —Ü–µ (—Ü—ñ–ª—å–æ–≤–∞ –∞—É–¥–∏—Ç–æ—Ä—ñ—è)
3. –ß–ò–ú –ö–û–†–ò–°–ù–ï (—è–∫—ñ –≤—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ –æ—Ç—Ä–∏–º–∞—é—Ç—å —É—á–∞—Å–Ω–∏–∫–∏ —á–∏ —â–æ –±—É–¥–µ –∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏)

–í–∏–º–æ–≥–∏ –¥–æ —Ç–µ–∫—Å—Ç—É:
‚Ä¢ –¢—ñ–ª—å–∫–∏ —Ñ–∞–∫—Ç–∏, –±–µ–∑ –∑–∞–∫–ª–∏–∫—ñ–≤ —Ç–∞ –µ–º–æ—Ü—ñ–π
‚Ä¢ –ú–æ–≤–∞: —É–∫—Ä–∞—ó–Ω—Å—å–∫–∞
‚Ä¢ –û–±'—î–º: –º–∞–∫—Å–∏–º—É–º 3 —Ä–µ—á–µ–Ω–Ω—è
‚Ä¢ –ó—Ä–æ–∑—É–º—ñ–ª–∏–π –¥–ª—è –º–æ–ª–æ–¥—ñ
‚Ä¢ –ë–µ–∑ —Å–ª—ñ–≤ "–¥—ñ–∑–Ω–∞—Ç–∏—Å—è", "–ø—Ä–∏–π–º–∞—Ç–∏ —É—á–∞—Å—Ç—å", "–ø–æ–¥—ñ–ª—ñ—Ç—å—Å—è"

–ü—Ä–∏–∫–ª–∞–¥ —Ñ–æ—Ä–º–∞—Ç—É:
"–û–ø–∏—Ç—É–≤–∞–Ω–Ω—è –¥–æ—Å–ª—ñ–¥–∂—É—î, —è–∫—ñ IT —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–æ—Å—Ç—ñ –ø—Ä–∏–≤–∞–±–ª—é—é—Ç—å –º–æ–ª–æ–¥—å [–©–û]. –û—Ä—ñ—î–Ω—Ç–æ–≤–∞–Ω–µ –Ω–∞ —à–∫–æ–ª—è—Ä—ñ–≤ —Ç–∞ —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤ [–î–õ–Ø –ö–û–ì–û]. –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –¥–æ–ø–æ–º–æ–∂—É—Ç—å –ó–ú–Ü —Ä–æ–∑—ñ–±—Ä–∞—Ç–∏—Å—è –≤ —Ç—Ä–µ–Ω–¥–∞—Ö –≤–∏–±–æ—Ä—É –ø—Ä–æ—Ñ–µ—Å—ñ–π [–ß–ò–ú –ö–û–†–ò–°–ù–ï]."
"""

        response = client.models.generate_content(
            model='gemini-2.5-flash',
            contents=prompt
        )
        return response.text

    except Exception as e:
        return None

    except Exception as e:
        return None